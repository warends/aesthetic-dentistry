/*unfold*/
(function ($) {
	"use strict";
	var ajaxQcw = new Map();
	var WidgetPDynamicQviewHandler = function($scope, $) {
		var qvwrap = $scope.find('.tp-quick-view-wrap-dl');

		if( qvwrap.length ){
			Quickview_dl(qvwrap);
		}

		function Quickview_dl(qvwrap){
			jQuery(qvwrap).off('click').on("click", function(event){
				event.preventDefault();

				var product_id = $(this).data('product-id'),
					customtemplate = $scope.find('.dynamic-listing').data("customtemplateqcw"),
					template = $scope.find('.dynamic-listing').data("templateqcw"),
					qvquery = $scope.find('.dynamic-listing').data("qvquery");

					if(product_id !== undefined){
						if ( !jQuery(this).find('i').hasClass('tpdlqactive') ) {
							jQuery(this).find('i').addClass('tpdlqactive').css('display','none');
						} 

						if ( !jQuery(this).find('.tp-dl-view-spinner').length > 0) {
							jQuery(this).append('<div class="tp-dl-view-spinner"></div>');	
						}

						jQuery.ajax({
							type: 'POST',
							url: theplus_ajax_url,
							data :{
								'action': 'tp_get_dl_post_info_ajax',
								'product_id':  product_id,
								'custom_template':  customtemplate,
								'template_id' : template,
								'qvquery' : qvquery,
								'status': 'publish',
								'security' : theplus_nonce,
							},
							beforeSend: function(jqXHR) {
								if( ajaxQcw != null && ajaxQcw.size != 0 && ajaxQcw.size != 'undefined' && typeof ajaxQcw.abort !== "undefined"  ) {
									ajaxQcw.abort();
								}

								ajaxQcw = jqXHR;
							},
							success:function(response){	
								$.fancybox.open(response);
								jQuery('.tp-dl-view-spinner').remove();
								jQuery('.tpdlqactive').css('display','block').removeClass('tpdlqactive');								
							},
							complete: function() {
							}
						});
					}
			});
		}

		var FindsearchFilter = document.querySelectorAll('.tp-search-filter');
        if( FindsearchFilter.length > 0 ){
            jQuery(document).ajaxComplete(function () {
                var qvwrap = $scope[0].querySelectorAll('.tp-quick-view-wrap-dl');
					Quickview_dl(qvwrap);
            });
        }

	};
	
	$(window).on('elementor/frontend/init', function () {
		elementorFrontend.hooks.addAction('frontend/element_ready/tp-dynamic-listing.default', WidgetPDynamicQviewHandler);
	});
})(jQuery);